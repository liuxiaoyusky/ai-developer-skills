---
name: doc-auditor
description: AI 辅助的项目文档审计工具。扫描项目中的 Markdown 文档，收集上下文信息（Git 历史、文档结构、引用有效性），AI 分析文档类型和重要性，与用户交互式确认处理方式。触发场景："清理过时文档"、"检查文档是否过时"、"审计项目文档"、"整理文档库"。
---

# Doc Auditor

AI 驱动的项目文档审计工具。扫描 Markdown 文档，收集上下文，智能分析文档类型，交互式确认处理方式。

## 核心原则

**False Positive > False Negative**

宁可把过时文档标记为 "review"（误报），也不要把设计文档标记为 "delete"（漏报）。

- 删除重要设计文档 = 💥💥💥 灾难
- 遗漏过时报告 = 😅 小问题，下次再处理

## 工作流程

### 步骤 1: 扫描文档

```bash
python scripts/scan_docs.py <项目目录> --output manifest.json
```

### 步骤 2: 收集文档上下文

```bash
python scripts/collect_context.py <文档路径> --project-root <项目根目录> --output context.json
```

**收集的内容**：
- 文档元数据（修改时间、文件大小、文件年龄）
- Git 历史（提交次数、最后修改时间、生命周期模式）
- 文档结构（标题、章节、开头段落）
- 问题列表（缺失的文件引用、上下文）

**输出示例**：
```json
{
  "doc_path": "docs/IMPLEMENTATION_SUMMARY.md",
  "metadata": {
    "modified_time": "2025-01-22 14:30",
    "size_formatted": "12.5 KB",
    "age_days": 1
  },
  "git_history": {
    "total_commits": 1,
    "days_since_last_commit": 1,
    "lifecycle_pattern": "one_time_created_recently"
  },
  "document_structure": {
    "title": "装备系统实现总结",
    "headings": ["## 概述", "## 实现", "## 数据文件"]
  },
  "issues": {
    "total_issues": 1,
    "issues": [
      {
        "type": "missing_file",
        "reference": "../data/achievements.json",
        "line_number": 581,
        "context": ["### 数据文件", "", ">>> **data/achievements.json**"]
      }
    ]
  }
}
```

### 步骤 3: AI 分析与交互确认

**关键**: 交互不是由 Python 脚本完成，而是由 **AI 与用户对话**完成。

## AI 文档分析指南

### 分析维度

AI 在分析文档时，应该考虑以下维度：

**1. 文档意图**（通过标题、开头、章节结构判断）
- 设计未来系统 → 设计文档
- 记录已完成工作 → 阶段性报告/状态文档
- 解释当前代码 → API 文档/技术文档

**2. Git 生命周期**
- `frequently_updated` → 活跃文档 → 高价值
- `one_time_created_recently` → 新文档 → 可能正在实现
- `one_time_created_old` → 旧文档 + 未更新 → 可能是阶段性报告
- `abandoned_or_complete` → 废弃或完成 → 需要确认

**3. 引用有效性**
- 引用不存在：
  - 设计文档 → 正常（文件可能还未实现）
  - API 文档 → 异常（需要同步）
  - 阶段性报告 → 数据可能已清理

**4. 问题严重性**
- 高严重程度问题数量 > 10 → 可能过时
- 高严重程度问题数量 < 3 → 可能正常

### 保守的分类标准

| 文档类型 | Git 特征 | 问题特征 | 建议 | 理由 |
|---------|---------|---------|------|------|
| **活跃设计文档** | 频繁更新（>3次） | 引用不存在 | `review` | 活跃维护，引用不存在是正常的 |
| **新设计文档** | 最近创建（<7天） | 引用不存在 | `review` | 可能正在实现中 |
| **阶段性报告** | 一次性创建 | 引用临时文件 | `review` | 需要确认是否仍需要 |
| **历史报告** | 一次性 + 长期未更新（>30天） | 引用不存在 | `archive` | 可能归档或删除 |
| **API 文档** | 任意状态 | 引用代码不存在 | `update` | 需要同步代码 |
| **活跃文档** | 频繁更新 | 无问题或少量问题 | `keep` | 正常维护 |
| **静态文档** | 一次性 + 长期未更新 | 无问题 | `keep` | 参考文档，保留 |

### AI 与用户的交互流程

```
AI: 我发现了一个可能过时的文档

    📄 IMPLEMENTATION_SUMMARY.md
    📅 最后修改: 2025-01-22（1天前）
    📦 文件大小: 12.5 KB

    Git 历史:
      • 1 天前创建，只提交了 1 次
      • 提交信息: "Add implementation summary"

    发现的问题:
      • 引用了 ../data/achievements.json（不存在）

    文档内容分析:
      • 标题: "装备系统实现总结"
      • 开头: "本文档总结了装备系统的完整实现..."
      • 章节: [概述, 实现, 数据文件]

    我的分析:
      这看起来是一个阶段性报告，记录已完成的工作。
      但引用的数据文件已经被清理。

      由于这是新创建的文档（1天前），
      我建议你确认一下：这个报告还需要保留吗？

    建议: review（需要你确认）

    你的选择:
      [1] 保留
      [2] 删除（创建备份）
      [3] 查看完整文档
      [4] 跳过

用户: 3

AI: [展示文档内容或更多细节...]
```

## 使用场景

### 场景 1: 项目阶段性清理

用户："项目开发过程中产生了很多阶段性文档，帮我清理一下过时的文档"

执行流程：
1. 扫描所有 Markdown 文件
2. 对每个文档收集上下文
3. AI 分析文档类型和重要性
4. 与用户逐个交互确认

### 场景 2: 检查单个文档

用户："检查 docs/api.md 是否过时"

执行流程：
1. 收集该文档的上下文
2. AI 分析文档类型和问题
3. 展示分析结果和建议

### 场景 3: 代码重构后的文档更新

用户："重构完成后，帮我检查哪些文档需要更新"

执行流程：
1. 扫描文档目录
2. 批量收集上下文
3. AI 识别 API 文档和受影响的文档
4. 生成需要更新的文档列表

## 批量处理

### 自动批量处理（谨慎使用）

```bash
python scripts/process_docs.py manifest.json --project-root <项目根目录> --dry-run
```

**警告**: 自动批量处理不会考虑文档类型，可能误删设计文档。

**建议**: 仅在以下情况使用自动批量处理：
- 已经过人工审查，确认可以批量处理
- 只处理明确过时的阶段性报告
- 使用 `--dry-run` 先预览结果

### AI 辅助的批量处理（推荐）

让 AI 逐个展示文档，与用户交互式确认。虽然较慢，但更安全。

## 注意事项

1. **保守策略**: 宁可保留过时文档，也不要删除重要文档
2. **备份优先**: 删除操作会自动创建 `.md.backup` 备份文件
3. **AI 辅助**: 依赖 AI 的理解能力，而不是硬编码规则
4. **交互确认**: 对于不确定的情况，总是与用户确认

## 技术细节

### 生命周期模式说明

- `frequently_updated`: 每 2 天至少一次提交
- `actively_maintained`: 最近 30 天内有更新
- `abandoned_or_complete`: 长期未更新（> 30 天）
- `one_time_created_recently`: 一次性创建，7 天内
- `one_time_created_old`: 一次性创建，超过 7 天
- `no_git_history`: 无 Git 记录
